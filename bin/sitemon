#!/usr/bin/env node

var program = require('commander');
var pkg = require("../package.json");
var sitemon = require("../index.js");

program
	.version(pkg.version)
	.option('-u, --url <url>', 'Required. URL to check for a 200 or 301 statuscode')
	.option('-c, --command <command>', 'Required. A command to run if the site is down.')
	.option('-i, --interval [interval]', 'Optional. How often, in minutes, should we check the site? Defaults to 5 minutes', 5)
	.option('-t, --timeout [timeout]', 'Optional. How long, in seconds, should we wait for the site to respond? Defaults to 30 seconds', 30)
	.option('-r, --retries [num]', 'Optional.  How many times should we try accessing the website before restarting it?  Defaults to 1', 1)
	.parse(process.argv);

sitemon(
	program.url,
	program.command,
	program.retries,
	((program.interval * 60 * 1000) / 2),
	(program.timeout * 1000),
	function(err){
		console.warn(new Date(), "Site is down!");
	},
	function(){
		console.info(new Date(), "Site is back up!");
	},
	function(){
		console.info(new Date(), "Site is up.  Status Code:", statusCode);
	},
	function(err, stdout, stderr) {
		if (err) console.error(new Date(), err);
		if (stdout) console.info(new Date(), stdout);
		if (stderr) console.error(new Date(), stderr);
	}
);

console.info(new Date(), "Monitoring...");